<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KrakenDuty - Multiple Scenarios at once - Script Generator</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ¦‘ </text></svg>">
    <style>
    :root {
        --primary-color: #666666;
        --secondary-color: #444444;
        --background-color: #f5f5f5;
        --text-color: #333333;
        --border-radius: 3px;
        --header-bg: #e0e0e0;
        --button-hover: #555555;
        --error-bg: #ffebee;
        --error-color: #c62828;
        --success-bg: #e0e0e0;
        --remove-button: #999999;
        --remove-button-hover: #777777;
        --custom-button: #888888;
        --custom-button-hover: #666666;
    }
    body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        color: var(--text-color);
        background-color: #ffffff;
    }
    h1,h2,h3 {color:#444444;}
    .section {
        background-color: var(--background-color);
        padding: 10px;
        padding-top: 1px;
        margin-bottom: 20px;
        border-radius: var(--border-radius);
        border: 1px solid #dddddd;
    }
    .field {display:flex;align-items:center;margin-bottom:10px;}
    label {flex:0 0 120px;margin-right:10px;}
    input {
        flex:1;
        padding:5px;
        margin-right:10px;
        width:100%;
        box-sizing:border-box;
        border: 1px solid #dddddd;
        border-radius: 3px;
    }
    select {
        padding: 5px;
        margin-right: 10px;
        box-sizing: border-box;
        width: auto;
        min-width: 100px;
        border: 1px solid #dddddd;
        border-radius: 3px;
    }
    button {
        background-color: var(--primary-color);
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: var(--border-radius);
        cursor: pointer;
    }
    button:hover {
        background-color: var(--secondary-color);
    }
    #result {
        margin-top:20px;
        padding:10px;
        background-color: var(--success-bg);
        border-radius:5px;
    }
    .scenario {
        border:1px solid #dddddd;
        padding:10px;
        margin-bottom:20px;
        border-radius:5px;
        background-color: #ffffff;
    }
    .scenario-header {display:flex;align-items:center;margin-bottom:10px;}
    .scenario-title {font-weight:bold;margin-right:10px;white-space:nowrap;}
    .scenario-type-container {flex-grow:1;display:flex;align-items:center;}
    .scenario-type {
        width: auto;
        min-width: 150px;
        max-width: 250px;
    }
    #scenarios-container select[id$="-severity"] {
        width: auto;
        min-width: 100px;
    }
    .scenario select {
        width: auto;
        min-width: 100px;
    }
    .remove-scenario,.remove-field {
        background-color: var(--remove-button);
        color:white;
        padding:5px 10px;
        border:none;
        border-radius:3px;
        cursor:pointer;
        white-space:nowrap;
        margin-left:10px;
    }
    .remove-scenario:hover,.remove-field:hover {
        background-color: var(--remove-button-hover);
    }
    .save-all-scenarios {
        background: #6c757d;
        color: white;
        border: none;
        border-radius: 3px;
        padding: 8px 15px;
        font-size: 0.8em;
        cursor: pointer;
        white-space: nowrap;
  }
    .save-all-scenarios:hover {
        background: #5a6268;
    }
    .scenario-actions {
        display: flex;
        gap: 10px;
        margin-top: 10px;
        flex-wrap: wrap;
    }
    .scenario-actions button {
        flex: 1;
        min-width: 120px;
    }
    .scenario-details {
        margin-top:10px;
        padding-top:10px;
        border-top:1px solid #dddddd;
    }
    .custom-details {
        margin-top:20px;
        padding:10px;
        background-color:#f8f8f8;
        border-radius:5px;
        border: 1px solid #dddddd;
    }
    .custom-field {display:flex;align-items:center;margin-bottom:10px;}
    .custom-field label {flex:0 0 155px;margin-right:10px;}
    .custom-field input[type="text"] {flex:1;width:100%;box-sizing:border-box;}
    .toggle-custom-details {
        display: block;
        width: auto;
        margin-top: 10px;
        margin-bottom: 10px;
        padding: 5px 10px;
        background-color: var(--custom-button);
        color: white;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        text-align: center;
    }
    .toggle-custom-details:hover {
        background-color: var(--custom-button-hover);
    }
    .add-customdetail {
        display: block;
        width: auto;
        margin-top: 10px;
        margin-bottom: 10px;
        padding: 5px 10px;
        background-color: var(--custom-button);
        color: white;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        text-align: center;
    }
    .add-customdetail:hover {
        background-color: var(--custom-button-hover);
    }
    h2 .subtext {font-size:0.6em;font-weight:normal;color:#666666;}
    pre {
        background-color:#f8f8f8;
        border:1px solid #dddddd;
        border-radius:4px;
        padding:10px;
        white-space:pre-wrap;
        word-wrap:break-word;
        font-family:monospace;
        font-size:14px;
        max-height:400px;
        overflow-y:auto;
    }
    #downloadShellScriptBtn {
        background-color: #777777;
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        margin-right: 15px;
        white-space: nowrap;
    }
    @media (max-width: 600px) {
        .button-group {
            flex-direction: column;
            align-items: flex-start;
        }
        #downloadShellScriptBtn {
            margin-bottom: 10px;
        }
        .scenario-actions {
            flex-direction: column;
        }
        .scenario-actions button {
            min-width: auto;
        }
    }
    #downloadShellScriptBtn:hover {background-color:#555555;}
    #hidePayloadBtn,#showPayloadBtn {
        background-color: var(--custom-button);
        color:white;
        padding:5px 10px;
        border:none;
        border-radius:3px;
        cursor:pointer;
        margin-bottom:10px;
        border-radius:3px;
    }
    #hidePayloadBtn:hover,#showPayloadBtn:hover {background-color:#666666;}
    .download-info {font-size: 0.9em;color: #666666;margin-left:-10px;}
    .payload-actions {margin-bottom: 15px;}
    .button-group {display: flex;align-items: center;flex-wrap: wrap;}
    .bold-select {
        font-weight:bold;
        -webkit-appearance:none;
        -moz-appearance:none;
        appearance:none;
        background-image:url("data:image/svg+xml;utf8,<svg fill='black' height='24' viewBox='0 0 24 24' width='24' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/><path d='M0 0h24v24H0z' fill='none'/></svg>");
        background-repeat:no-repeat;
        background-position-x:100%;
        background-position-y:5px;
        padding-right:25px;
    }
    .colored-header {
        background-color: var(--header-bg);
        padding:10px;
        border-radius:5px 5px 0 0;
        display:flex;
        align-items:center;
        justify-content:space-between;
        border-bottom: 1px solid #dddddd;
    }
    #sendEventsBtn {
        background-color:#424242;
        padding:12px 24px;
        font-size:18px;
        font-weight:bold;
        border-radius:3px;
    }
    #sendEventsBtn:hover {background-color:#161515;}
    .title-group {text-align:center;margin-bottom:20px;}
    .version {font-size:0.4em;font-weight:normal;color:#666666;margin-left:10px;}
    .bug-report {
        margin-top:20px;
        padding:10px;
        text-align:center;
        font-size:0.9em;
        border-top:1px solid #dddddd;
    }
    .bug-report a {color:#666666;text-decoration:none;}
    .bug-report a:hover {text-decoration:underline;}
    .error-message {
        background-color: #f0f0f0;
        color: #444444;
        padding: 10px;
        border-radius: 3px;
        margin-bottom: -10px;
        margin-top: 10px;
        border: 1px solid #dddddd;
    }
    .error-list {list-style-type: none;padding-left: 0;}
    .error-list li {margin-bottom: 5px;}
    #event-action-field {display: flex;align-items: center;flex-wrap: nowrap;}
    #event-action-field select {margin-right: 10px;}
    .checkbox-label {
        display: flex;
        align-items: center;
        white-space: nowrap;
        font-size: 0.9em;
    }
    .checkbox-label input[type="checkbox"] {margin-right: 5px;}
    .main-title {
        font-size: 2.5em;
        margin-bottom: 0.5em;
        color: #444444;
    }
    .sub-title {font-size: 1.8em;}

    /* Enhanced Routing Key Management */
    .routing-key-container {
        position: relative;
    }
    .routing-key-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #dddddd;
        border-top: none;
        border-radius: 0 0 3px 3px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
    }
    .routing-key-item {
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .routing-key-item:hover {
        background-color: #f5f5f5;
    }
    .routing-key-item:last-child {
        border-bottom: none;
    }
    .routing-key-name {
        font-weight: bold;
        color: #333;
    }
    .routing-key-preview {
        font-family: monospace;
        color: #666;
        font-size: 0.9em;
    }
    .routing-key-delete {
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 3px;
        padding: 2px 6px;
        font-size: 0.8em;
        cursor: pointer;
        margin-left: 8px;
    }
    .routing-key-delete:hover {
        background: #c82333;
    }
    .routing-key-actions {
        display: flex;
        gap: 5px;
        margin-top: 5px;
        flex-wrap: wrap;
    }

    .routing-key-save, .routing-key-load {
        background: #6c757d;
        color: white;
        border: none;
        border-radius: 3px;
        padding: 5px 10px;
        font-size: 0.8em;
        cursor: pointer;
        white-space: nowrap;
    }

    .routing-key-save:hover, .routing-key-load:hover {
        background: #5a6268;
    }

    /* Responsive behavior for routing key actions */
    @media (max-width: 600px) {
        .routing-key-actions {
            flex-direction: column;
        }

        .routing-key-save, .routing-key-load {
            width: 100%;
            margin-bottom: 3px;
        }
    }
    /* Scenario Management Enhancements */
    .scenario-set-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
        flex-wrap: wrap;
    }
    .scenario-set-item {
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .scenario-set-item:hover {
        background-color: #f5f5f5;
    }
    .scenario-set-name {
        font-weight: bold;
        color: #333;
    }
    .scenario-set-count {
        color: #666;
        font-size: 0.9em;
    }
    .scenario-set-delete {
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 3px;
        padding: 2px 6px;
        font-size: 0.8em;
        cursor: pointer;
        margin-left: 8px;
    }

    /* Toast Messages */
    .toast-container {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1000;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .toast {
        background-color: #333333;
        color: white;
        padding: 15px 25px;
        border-radius: 3px;
        margin-top: 10px;
        opacity: 0;
        transform: translateY(100%);
        animation: slideUp 0.3s ease forwards;
        display: flex;
        align-items: center;
        justify-content: space-between;
        min-width: 200px;
        max-width: 400px;
        box-shadow: 0 3px 6px rgba(0,0,0,0.16);
    }

    .toast.success {
        background-color: #4CAF50;
    }

    .toast.error {
        background-color: #f44336;
    }

    .toast.info {
        background-color: #2196F3;
    }

    .toast.warning {
        background-color: #ff9800;
    }

    .toast .close-toast {
        background: transparent;
        border: none;
        color: white;
        padding: 0 5px;
        cursor: pointer;
        font-size: 20px;
        margin-left: 10px;
    }

    .toast .close-toast:hover {
        opacity: 0.8;
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(100%);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes slideOut {
        from {
            opacity: 1;
            transform: translateY(0);
        }
        to {
            opacity: 0;
            transform: translateY(100%);
        }
    }

    .toast.hiding {
      animation: slideOut 0.3s ease forwards;
    }

    /* Input validation styles */
    .field-error {
        border-color: #dc3545 !important;
        background-color: #fff5f5;
    }
    .field-success {
        border-color: #28a745 !important;
    }
    .validation-message {
        font-size: 0.8em;
        margin-top: 2px;
        margin-left: 130px;
    }
    .validation-error {
        color: #dc3545;
    }
    .validation-success {
        color: #28a745;
    }

</style>
</head>
<body>
    <header class="title-group">
        <h1 class="main-title">KrakenDuty</h1>
        <h1 class="sub-title">PagerDuty Event V2 Sender <span class="version">v1.3 (unofficial)</span></h1>
        <h2>Multiple Scenarios at once - Script Generator</h2>
    </header>

    <div class="section">
        <h2>Common Fields <span class="subtext">Will be applied to every event</span></h2>
        <div id="routing-key-field" class="field">
            <label for="routing_key">Routing Key:</label>
            <div class="routing-key-container" style="flex: 1;">
                <input type="text" id="routing_key" placeholder="PASTE YOUR ROUTING KEY HERE">
                <div id="routing-key-dropdown" class="routing-key-dropdown"></div>
                <div class="routing-key-actions">
                    <button type="button" class="routing-key-save" onclick="saveCurrentRoutingKey()">Save Key</button>
                    <button type="button" class="routing-key-load" onclick="toggleRoutingKeyDropdown()">Load Key</button>
                    <button type="button" class="routing-key-load" onclick="manageRoutingKeysUI()">Manage Keys</button>
                </div>
            </div>
        </div>
        <div id="event-action-field" class="field">
            <label for="event_action">Event Action:</label>
            <select id="event_action" onchange="toggleDedupKeyField()">
                <option value="trigger">Trigger</option>
                <option value="acknowledge">Acknowledge</option>
                <option value="resolve">Resolve</option>
            </select>
            <label for="dedup_key_for_trigger" class="checkbox-label" id="dedup-key-checkbox-label">
                <input type="checkbox" id="dedup_key_for_trigger" onchange="toggleDedupKeyField()">
                <span>OPTIONAL: Wanna use your own dedup key?</span>
            </label>
        </div>
        <div id="dedup-key-field" class="field" style="display: none;">
            <label for="dedup_key">Dedup Key:</label>
            <input type="text" id="dedup_key" placeholder="Enter your dedup key" oninput="toggleDedupKeyField()">
        </div>
        <div id="dedup-key-error" class="error-message" style="display: none;"></div>
        <input type="hidden" id="client" value="KrakenDuty">
    </div>

    <div class="section">
        <h2>Scenarios <span class="subtext">Go nuts!</span></h2>
        <div id="scenarios-container"></div>
        <div class="scenario-actions">
            <button class="save-all-scenarios" onclick="addScenario()">Add Scenario</button>
            <button class="save-all-scenarios" onclick="clearAllScenariosUI()">Clear All Scenarios</button>
        </div>
        <div class="scenario-set-actions">
            <button class="save-all-scenarios" onclick="saveScenarioSet()">Save Scenario Set</button>
            <button class="save-all-scenarios" onclick="loadScenarioSetUI()">Load Scenario Set</button>
            <button class="save-all-scenarios" onclick="manageScenarioSetsUI()">Manage Scenario Sets</button>
        </div>
    </div>

    <button id="sendEventsBtn" onclick="sendEvents()">Release the Kraken! ðŸ¦‘ </button>
    <button id="showPayloadBtn" onclick="showPayload()">Show Payload</button>
    <button id="hidePayloadBtn" onclick="hidePayload()" style="display: none;">Hide Payload</button>

    <div id="error-container"></div>
    <div id="result"></div>

    <div id="payload-preview" style="display: none;">
        <h3>Payload Preview</h3>
        <div class="payload-actions">
            <div class="button-group">
                <button id="downloadShellScriptBtn" onclick="downloadShellScript()">Download Shell Script</button>
                <span class="download-info">Download a shell script with desired scenario(s) to send events via command line ðŸ¤“.</span>
            </div>
        </div>
        <pre class="payload-preview"></pre>
    </div>

    <div class="bug-report">
        <p>Found a bug? / Have an idea? <a href="https://github.com/jplassnibatt/pd_events/issues" target="_blank" rel="noopener noreferrer">Open an issue on GitHub</a></p>
    </div>

    <script>
        // Enhanced Data Management System
        // Enhanced Data Management System with duplicate name prevention
        class KrakenDutyStorage {
            constructor() {
                this.storageKey = 'krakenduty_data';
                this.init();
            }

            init() {
                try {
                    const data = localStorage.getItem(this.storageKey);
                    if (!data) {
                        this.resetStorage();
                    }
                } catch (error) {
                    console.error('Storage initialization failed:', error);
                    this.resetStorage();
                }
            }

            resetStorage() {
                const defaultData = {
                    routingKeys: {},
                    scenarioSets: {},
                    version: '1.2'
                };
                localStorage.setItem(this.storageKey, JSON.stringify(defaultData));
            }

            getData() {
                try {
                    return JSON.parse(localStorage.getItem(this.storageKey)) || {};
                } catch (error) {
                    console.error('Failed to parse storage data:', error);
                    this.resetStorage();
                    return this.getData();
                }
            }

            saveData(data) {
                try {
                    localStorage.setItem(this.storageKey, JSON.stringify(data));
                    return true;
                } catch (error) {
                    console.error('Failed to save data:', error);
                    return false;
                }
            }

            // Enhanced Routing Key Management with duplicate prevention
            isRoutingKeyNameExists(name, excludeId = null) {
                const data = this.getData();
                const normalizedName = name.trim().toLowerCase();
                return Object.values(data.routingKeys || {}).some(key =>
                    key.name.toLowerCase() === normalizedName && key.id !== excludeId
                );
            }

            saveRoutingKey(name, key) {
                const trimmedName = name.trim();
                if (this.isRoutingKeyNameExists(trimmedName)) {
                    throw new Error(`A routing key with the name "${trimmedName}" already exists. Please choose a different name.`);
                }

                const data = this.getData();
                const id = this.generateId();
                data.routingKeys[id] = {
                    id,
                    name: trimmedName,
                    key: key,
                    created: new Date().toISOString(),
                    lastUsed: new Date().toISOString()
                };
                return this.saveData(data) ? id : null;
            }

            updateRoutingKey(id, name, key) {
                const trimmedName = name.trim();
                if (this.isRoutingKeyNameExists(trimmedName, id)) {
                    throw new Error(`A routing key with the name "${trimmedName}" already exists. Please choose a different name.`);
                }

                const data = this.getData();
                if (data.routingKeys[id]) {
                    data.routingKeys[id].name = trimmedName;
                    data.routingKeys[id].key = key;
                    data.routingKeys[id].lastUsed = new Date().toISOString();
                    return this.saveData(data);
                }
                return false;
            }

            getRoutingKeys() {
                const data = this.getData();
                return Object.values(data.routingKeys || {}).sort((a, b) =>
                    new Date(b.lastUsed) - new Date(a.lastUsed)
                );
            }

            getRoutingKey(id) {
                const data = this.getData();
                return data.routingKeys[id] || null;
            }

            updateRoutingKeyUsage(id) {
                const data = this.getData();
                if (data.routingKeys[id]) {
                    data.routingKeys[id].lastUsed = new Date().toISOString();
                    this.saveData(data);
                }
            }

            deleteRoutingKey(id) {
                const data = this.getData();
                delete data.routingKeys[id];
                return this.saveData(data);
            }

            // Enhanced Scenario Set Management with duplicate prevention
            isScenarioSetNameExists(name, excludeId = null) {
                const data = this.getData();
                const normalizedName = name.trim().toLowerCase();
                return Object.values(data.scenarioSets || {}).some(set =>
                    set.name.toLowerCase() === normalizedName && set.id !== excludeId
                );
            }

            saveScenarioSet(name, scenarios, routingKeyId = null) {
                const trimmedName = name.trim();
                if (this.isScenarioSetNameExists(trimmedName)) {
                    throw new Error(`A scenario set with the name "${trimmedName}" already exists. Please choose a different name.`);
                }

                const data = this.getData();
                const id = this.generateId();
                data.scenarioSets[id] = {
                    id,
                    name: trimmedName,
                    scenarios,
                    routingKeyId,
                    created: new Date().toISOString(),
                    lastUsed: new Date().toISOString()
                };
                return this.saveData(data) ? id : null;
            }

            updateScenarioSet(id, name, scenarios, routingKeyId = null) {
                const trimmedName = name.trim();
                if (this.isScenarioSetNameExists(trimmedName, id)) {
                    throw new Error(`A scenario set with the name "${trimmedName}" already exists. Please choose a different name.`);
                }

                const data = this.getData();
                if (data.scenarioSets[id]) {
                    data.scenarioSets[id].name = trimmedName;
                    data.scenarioSets[id].scenarios = scenarios;
                    data.scenarioSets[id].routingKeyId = routingKeyId;
                    data.scenarioSets[id].lastUsed = new Date().toISOString();
                    return this.saveData(data);
                }
                return false;
            }

            getScenarioSets() {
                const data = this.getData();
                return Object.values(data.scenarioSets || {}).sort((a, b) =>
                    new Date(b.lastUsed) - new Date(a.lastUsed)
                );
            }

            getScenarioSet(id) {
                const data = this.getData();
                return data.scenarioSets[id] || null;
            }

            updateScenarioSetUsage(id) {
                const data = this.getData();
                if (data.scenarioSets[id]) {
                    data.scenarioSets[id].lastUsed = new Date().toISOString();
                    this.saveData(data);
                }
            }

            deleteScenarioSet(id) {
                const data = this.getData();
                delete data.scenarioSets[id];
                return this.saveData(data);
            }

            generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }

            // Utility method to suggest alternative names
            suggestAlternativeName(baseName, type = 'routingKey') {
                const checkMethod = type === 'routingKey' ? 'isRoutingKeyNameExists' : 'isScenarioSetNameExists';
                let counter = 1;
                let suggestedName = `${baseName} (${counter})`;

                while (this[checkMethod](suggestedName)) {
                    counter++;
                    suggestedName = `${baseName} (${counter})`;
                }

                return suggestedName;
            }
        }

        // Initialize storage system
        const storage = new KrakenDutyStorage();

        // Scenario templates remain the same
        const scenarioTemplates = {
            application: {summary:"Application unresponsive - multiple user reports",severity:"error",source:"app-server-02.us-east-4.com",component:"E-commerce Application",group:"Application Stack",class:"Availability",customDetails:{error_rate:"15%",response_time:"10s",affected_users:"500+"}},
            container:{summary:"Container orchestration system failure - multiple pods crashing",severity:"critical",source:"k8s-cluster-01.us-east-1.com",component:"Kubernetes Cluster",group:"Container Platform",class:"Availability",customDetails:{failed_pods:"12",memory_usage:"93%",restart_count:"25"}},
            cpu: {summary:"Excessive CPU usage detected on production web server",severity:"critical",source:"web-server-05.us-east-2.com",component:"Apache Web Server",group:"Web Infrastructure",class:"Performance",customDetails:{cpu_usage:"95%",process_count:"250",load_average:"8.5"}},
            database: {summary:"High latency and connection timeouts in primary database cluster",severity:"critical",source:"db-cluster-01.us-east-1.com",component:"PostgreSQL",group:"Database Infrastructure",class:"Performance Degradation",customDetails:{db_name:"primary_cluster",connection_count:"500",avg_query_time:"2.5s"}},
            disk: {summary:"Critical disk space shortage on file server",severity:"critical",source:"file-server-03.us-east-3.com",component:"Storage System",group:"Storage Infrastructure",class:"Capacity",customDetails:{disk_usage:"98%",free_space:"20GB",affected_partition:"/dev/sda1"}},
            login: {summary:"Multiple failed login attempts detected",severity:"error",source:"auth-server-01.us-west-1.com",component:"Authentication Service",group:"Login",class:"Security Threat",customDetails:{failed_attempts:"100+",affected_accounts:"25",source_ip:"192.168.1.100"}},
            network: {summary:"Network connectivity issues affecting multiple services",severity:"critical",source:"core-switch-01.us-west-2.com",component:"Core Network Infrastructure",group:"Network",class:"Connectivity",customDetails:{packet_loss:"25%",affected_vlans:"VLAN 10, VLAN 20",bandwidth_utilization:"90%"}}
        };

        let currentRoutingKey = '';
        let currentRoutingKeyId = null;

        /**
         * Enhanced routing key management with persistent storage
         */
        function maskRoutingKey(key) {
            if (!key) return '';
            const maskLength = Math.min(20, key.length);
            return 'â€¢'.repeat(maskLength) + key.slice(maskLength);
        }

        function handleRoutingKeyInput(event) {
            const inputField = event.target;
            const cursorPosition = inputField.selectionStart;
            const currentValue = inputField.value;

            // Update current routing key
            if (currentValue !== maskRoutingKey(currentRoutingKey)) {
                if (!currentValue.includes('â€¢')) {
                    currentRoutingKey = currentValue;
                    currentRoutingKeyId = null; // Reset ID when manually typing
                } else {
                    const visiblePart = currentValue.slice(20);
                    currentRoutingKey = currentRoutingKey.slice(0, 20) + visiblePart;
                }
            }

            // Validate routing key
            validateRoutingKey(currentRoutingKey);

            // Show masked version in UI
            setTimeout(() => {
                inputField.value = maskRoutingKey(currentRoutingKey);
                if (cursorPosition > 20) {
                    inputField.selectionStart = cursorPosition;
                    inputField.selectionEnd = cursorPosition;
                }
            }, 0);
        }

        function validateRoutingKey(key) {
            const field = document.getElementById('routing_key');
            const existingMessage = field.parentNode.querySelector('.validation-message');

            if (existingMessage) {
                existingMessage.remove();
            }

            if (!key) {
                field.classList.remove('field-success', 'field-error');
                return;
            }

            // Basic validation - PagerDuty routing keys are typically 32 characters
            if (key.length == 32) {
              field.classList.add('field-success');
              field.classList.remove('field-error');
              const message = document.createElement('div');
              message.className = 'validation-message validation-success';
              message.textContent = 'Routing key format looks good';
              field.parentNode.appendChild(message);
            } else {
                field.classList.add('field-error');
                field.classList.remove('field-success');
                const message = document.createElement('div');
                message.className = 'validation-message validation-error';
                message.textContent = 'Routing key appears to be incomplete (typically 32 characters)';
                field.parentNode.appendChild(message);
            }
        }

        function saveCurrentRoutingKey() {
            if (!currentRoutingKey) {
                showToast('Please enter a routing key first', 'warning');
                return;
            }

            const name = prompt('Enter a name for this routing key:');
            if (!name || !name.trim()) {
                showToast('Please provide a name for the routing key', 'warning');
                return;
            }

            try {
                const id = storage.saveRoutingKey(name, currentRoutingKey);
                if (id) {
                    currentRoutingKeyId = id;
                    showToast(`Routing key "${name.trim()}" saved successfully!`, 'success');
                } else {
                    showToast('Failed to save routing key', 'error');
                }
            } catch (error) {
                // Handle duplicate name error
                const suggestedName = storage.suggestAlternativeName(name.trim(), 'routingKey');
                const useAlternative = confirm(`${error.message}\n\nWould you like to use "${suggestedName}" instead?`);

                if (useAlternative) {
                    try {
                        const id = storage.saveRoutingKey(suggestedName, currentRoutingKey);
                        if (id) {
                            currentRoutingKeyId = id;
                            showToast(`Routing key "${suggestedName}" saved successfully!`, 'success');
                        } else {
                            showToast('Failed to save routing key', 'error');
                        }
                    } catch (secondError) {
                        showToast(`Error: ${secondError.message}`, 'error');
                    }
                } else {
                    showToast('Routing key not saved', 'info');
                }
            }
        }

        function toggleRoutingKeyDropdown() {
            const dropdown = document.getElementById('routing-key-dropdown');
            const keys = storage.getRoutingKeys();

            if (keys.length === 0) {
                showToast('No saved routing keys found', 'info');
                return;
            }

            if (dropdown.style.display === 'block') {
                dropdown.style.display = 'none';
                return;
            }

            dropdown.innerHTML = '';
            keys.forEach(keyData => {
                const item = document.createElement('div');
                item.className = 'routing-key-item';
                item.innerHTML = `
                    <div>
                        <div class="routing-key-name">${escapeHtml(keyData.name)}</div>
                        <div class="routing-key-preview">${maskRoutingKey(keyData.key)}</div>
                    </div>
                    <button class="routing-key-delete" onclick="deleteRoutingKey('${keyData.id}', event)">Ã—</button>
                `;

                item.addEventListener('click', (e) => {
                    if (e.target.classList.contains('routing-key-delete')) return;
                    loadRoutingKey(keyData.id);
                    dropdown.style.display = 'none';
                });

                dropdown.appendChild(item);
            });

            dropdown.style.display = 'block';
        }

        function loadRoutingKey(id) {
            const keyData = storage.getRoutingKey(id);
            if (!keyData) {
                showToast('Routing key not found', 'error');
                return;
            }

            currentRoutingKey = keyData.key;
            currentRoutingKeyId = id;
            document.getElementById('routing_key').value = maskRoutingKey(keyData.key);
            storage.updateRoutingKeyUsage(id);
            validateRoutingKey(keyData.key);
            showToast(`Loaded routing key: ${keyData.name}`, 'success');
            updatePayload();
        }

        function deleteRoutingKey(id, event) {
            event.stopPropagation();
            const keyData = storage.getRoutingKey(id);
            if (!keyData) return;

            if (confirm(`Delete routing key "${keyData.name}"?`)) {
                if (storage.deleteRoutingKey(id)) {
                    showToast(`Deleted routing key: ${keyData.name}`, 'success');
                    toggleRoutingKeyDropdown(); // Refresh dropdown
                    if (currentRoutingKeyId === id) {
                        currentRoutingKey = '';
                        currentRoutingKeyId = null;
                        document.getElementById('routing_key').value = '';
                    }
                } else {
                    showToast('Failed to delete routing key', 'error');
                }
            }
        }

        /**
         * Enhanced scenario set management
         */
         function saveScenarioSet() {
             const scenarios = document.querySelectorAll('.scenario');
             if (scenarios.length === 0) {
                 showToast('No scenarios to save!', 'warning');
                 return;
             }

             const name = prompt('Enter a name for this scenario set:');
             if (!name || !name.trim()) {
                 showToast('Please provide a name for the scenario set', 'warning');
                 return;
             }

             try {
                 const scenariosData = Array.from(scenarios).map(scenario => {
                     const scenarioId = scenario.id;
                     return extractScenarioData(scenarioId);
                 });

                 const id = storage.saveScenarioSet(name, scenariosData, currentRoutingKeyId);
                 if (id) {
                     showToast(`Scenario set "${name.trim()}" saved successfully!`, 'success');
                 } else {
                     showToast('Failed to save scenario set', 'error');
                 }
             } catch (error) {
                 if (error.message.includes('already exists')) {
                     // Handle duplicate name error
                     const suggestedName = storage.suggestAlternativeName(name.trim(), 'scenarioSet');
                     const useAlternative = confirm(`${error.message}\n\nWould you like to use "${suggestedName}" instead?`);

                     if (useAlternative) {
                         try {
                             const scenariosData = Array.from(scenarios).map(scenario => {
                                 const scenarioId = scenario.id;
                                 return extractScenarioData(scenarioId);
                             });

                             const id = storage.saveScenarioSet(suggestedName, scenariosData, currentRoutingKeyId);
                             if (id) {
                                 showToast(`Scenario set "${suggestedName}" saved successfully!`, 'success');
                             } else {
                                 showToast('Failed to save scenario set', 'error');
                             }
                         } catch (secondError) {
                             showToast(`Error: ${secondError.message}`, 'error');
                         }
                     } else {
                         showToast('Scenario set not saved', 'info');
                     }
                 } else {
                     console.error('Error saving scenario set:', error);
                     showToast(`Error saving scenario set: ${error.message}`, 'error');
                 }
             }
         }

        function loadScenarioSetUI() {
            const sets = storage.getScenarioSets();
            if (sets.length === 0) {
                showToast('No saved scenario sets found', 'info');
                return;
            }

            const setNames = sets.map(set => `${set.name} (${set.scenarios.length} scenarios)`);
            const selectedIndex = prompt(`Select a scenario set to load:\n${setNames.map((name, i) => `${i + 1}. ${name}`).join('\n')}\n\nEnter the number:`);

            if (selectedIndex && !isNaN(selectedIndex)) {
                const index = parseInt(selectedIndex) - 1;
                if (index >= 0 && index < sets.length) {
                    loadScenarioSet(sets[index].id);
                } else {
                    showToast('Invalid selection', 'warning');
                }
            }
        }

        // Enhanced management UI with rename functionality
        function manageRoutingKeysUI() {
            const keys = storage.getRoutingKeys();
            if (keys.length === 0) {
                showToast('No saved routing keys found', 'info');
                return;
            }

            const keyList = keys.map((key, i) =>
                `${i + 1}. ${key.name} - Created: ${new Date(key.created).toLocaleDateString()}`
            ).join('\n');

            const action = prompt(`Routing Key Management:\n${keyList}\n\nEnter 'delete X' to delete key X, 'rename X' to rename key X, or click 'cancel' to exit:`);

            if (!action || action.toLowerCase() === 'cancel') {
                return; // User cancelled or entered 'cancel'
            }

            if (action.toLowerCase().startsWith('delete ')) {
                const index = parseInt(action.split(' ')[1]) - 1;
                if (index >= 0 && index < keys.length) {
                    const keyToDelete = keys[index];
                    if (confirm(`Delete routing key "${keyToDelete.name}"?`)) {
                        if (storage.deleteRoutingKey(keyToDelete.id)) {
                            showToast(`Deleted routing key: ${keyToDelete.name}`, 'success');
                            if (currentRoutingKeyId === keyToDelete.id) {
                                currentRoutingKey = '';
                                currentRoutingKeyId = null;
                                document.getElementById('routing_key').value = '';
                            }
                        } else {
                            showToast('Failed to delete routing key', 'error');
                        }
                    }
                } else {
                    showToast('Invalid selection', 'warning');
                }
            } else if (action.toLowerCase().startsWith('rename ')) {
                const index = parseInt(action.split(' ')[1]) - 1;
                if (index >= 0 && index < keys.length) {
                    const keyToRename = keys[index];
                    const newName = prompt(`Enter new name for "${keyToRename.name}":`, keyToRename.name);
                    if (newName && newName.trim() && newName.trim() !== keyToRename.name) {
                        try {
                            if (storage.updateRoutingKey(keyToRename.id, newName, keyToRename.key)) {
                                showToast(`Renamed routing key to: ${newName.trim()}`, 'success');
                            } else {
                                showToast('Failed to rename routing key', 'error');
                            }
                        } catch (error) {
                            showToast(`Error: ${error.message}`, 'error');
                        }
                    }
                } else {
                    showToast('Invalid selection', 'warning');
                }
            } else {
                // Invalid command entered
                showToast('Wrong choice. Please enter "delete X", "rename X", or click "cancel".', 'warning');
            }
        }

        function loadScenarioSet(id) {
            const setData = storage.getScenarioSet(id);
            if (!setData) {
                showToast('Scenario set not found', 'error');
                return;
            }

            try {
                // Load associated routing key if available
                if (setData.routingKeyId) {
                    const keyData = storage.getRoutingKey(setData.routingKeyId);
                    if (keyData) {
                        currentRoutingKey = keyData.key;
                        currentRoutingKeyId = setData.routingKeyId;
                        document.getElementById('routing_key').value = maskRoutingKey(keyData.key);
                        storage.updateRoutingKeyUsage(setData.routingKeyId);
                    }
                }

                // Clear existing scenarios
                document.getElementById('scenarios-container').innerHTML = '';

                // Load scenarios
                setData.scenarios.forEach((scenarioData, index) => {
                    const scenarioId = createScenarioFromData(scenarioData, index + 1);
                    populateScenarioData(scenarioId, scenarioData);
                });

                storage.updateScenarioSetUsage(id);
                showToast(`Loaded scenario set: ${setData.name}`, 'success');
                updatePayload();
            } catch (error) {
                console.error('Error loading scenario set:', error);
                showToast('Error loading scenario set!', 'error');
            }
        }

        function manageScenarioSetsUI() {
            const sets = storage.getScenarioSets();
            if (sets.length === 0) {
                showToast('No saved scenario sets found', 'info');
                return;
            }

            const setList = sets.map((set, i) =>
                `${i + 1}. ${set.name} (${set.scenarios.length} scenarios) - Created: ${new Date(set.created).toLocaleDateString()}`
            ).join('\n');

            const action = prompt(`Scenario Set Management:\n${setList}\n\nEnter 'delete X' to delete set X, 'rename X' to rename set X, or click 'cancel' to exit:`);

            if (!action || action.toLowerCase() === 'cancel') {
                return; // User cancelled or entered 'cancel'
            }

            if (action.toLowerCase().startsWith('delete ')) {
                const index = parseInt(action.split(' ')[1]) - 1;
                if (index >= 0 && index < sets.length) {
                    const setToDelete = sets[index];
                    if (confirm(`Delete scenario set "${setToDelete.name}"?`)) {
                        if (storage.deleteScenarioSet(setToDelete.id)) {
                            showToast(`Deleted scenario set: ${setToDelete.name}`, 'success');
                        } else {
                            showToast('Failed to delete scenario set', 'error');
                        }
                    }
                } else {
                    showToast('Invalid selection', 'warning');
                }
            } else if (action.toLowerCase().startsWith('rename ')) {
                const index = parseInt(action.split(' ')[1]) - 1;
                if (index >= 0 && index < sets.length) {
                    const setToRename = sets[index];
                    const newName = prompt(`Enter new name for "${setToRename.name}":`, setToRename.name);
                    if (newName && newName.trim() && newName.trim() !== setToRename.name) {
                        try {
                            if (storage.updateScenarioSet(setToRename.id, newName, setToRename.scenarios, setToRename.routingKeyId)) {
                                showToast(`Renamed scenario set to: ${newName.trim()}`, 'success');
                            } else {
                                showToast('Failed to rename scenario set', 'error');
                            }
                        } catch (error) {
                            showToast(`Error: ${error.message}`, 'error');
                        }
                    }
                } else {
                    showToast('Invalid selection', 'warning');
                }
            } else {
                // Invalid command entered
                showToast('Wrong choice. Please enter "delete X", "rename X", or click "cancel".', 'warning');
            }
        }

        /**
         * Enhanced scenario management functions
         */
        function extractScenarioData(scenarioId) {
            const componentField = document.getElementById(`${scenarioId}-component-field`);
            const groupField = document.getElementById(`${scenarioId}-group-field`);
            const classField = document.getElementById(`${scenarioId}-class-field`);

            return {
                type: document.getElementById(`${scenarioId}-type`).value,
                summary: document.getElementById(`${scenarioId}-summary`).value,
                severity: document.getElementById(`${scenarioId}-severity`).value,
                source: document.getElementById(`${scenarioId}-source`).value,
                component: componentField && componentField.style.display !== 'none' ?
                    document.getElementById(`${scenarioId}-component`).value : '',
                group: groupField && groupField.style.display !== 'none' ?
                    document.getElementById(`${scenarioId}-group`).value : '',
                class: classField && classField.style.display !== 'none' ?
                    document.getElementById(`${scenarioId}-class`).value : '',
                removedFields: {
                    component: !componentField || componentField.style.display === 'none',
                    group: !groupField || groupField.style.display === 'none',
                    class: !classField || classField.style.display === 'none'
                },
                customDetails: getCustomDetails(scenarioId)
            };
        }

        function createScenarioFromData(scenarioData, scenarioNumber) {
            const container = document.getElementById('scenarios-container');
            const scenarioId = `scenario-${Date.now()}-${scenarioNumber}`;

            const scenarioHtml = createScenarioHTML(scenarioId, scenarioNumber);
            container.insertAdjacentHTML('beforeend', scenarioHtml);

            return scenarioId;
        }

        function populateScenarioData(scenarioId, scenarioData) {
            // Set basic fields
            document.getElementById(`${scenarioId}-type`).value = scenarioData.type;
            document.getElementById(`${scenarioId}-summary`).value = scenarioData.summary;
            document.getElementById(`${scenarioId}-severity`).value = scenarioData.severity;
            document.getElementById(`${scenarioId}-source`).value = scenarioData.source;

            // Handle optional fields
            const componentField = document.getElementById(`${scenarioId}-component-field`);
            const groupField = document.getElementById(`${scenarioId}-group-field`);
            const classField = document.getElementById(`${scenarioId}-class-field`);

            if (scenarioData.removedFields?.component) {
                componentField.style.display = 'none';
            } else {
                document.getElementById(`${scenarioId}-component`).value = scenarioData.component || '';
            }

            if (scenarioData.removedFields?.group) {
                groupField.style.display = 'none';
            } else {
                document.getElementById(`${scenarioId}-group`).value = scenarioData.group || '';
            }

            if (scenarioData.removedFields?.class) {
                classField.style.display = 'none';
            } else {
                document.getElementById(`${scenarioId}-class`).value = scenarioData.class || '';
            }

            // Handle custom details
            if (Object.keys(scenarioData.customDetails || {}).length > 0) {
                const customDetailsContainer = document.getElementById(`${scenarioId}-custom-details`);
                customDetailsContainer.style.display = 'block';
                customDetailsContainer.innerHTML = `<h3>Custom Details for Scenario ${scenarioData.scenarioNumber || 1}</h3>`;

                Object.entries(scenarioData.customDetails).forEach(([key, value]) => {
                    const fieldId = `${scenarioId}-custom-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                    customDetailsContainer.insertAdjacentHTML('beforeend', `
                        <div class="custom-field" id="${fieldId}">
                            <label for="${fieldId}-value">${escapeHtml(key)}:</label>
                            <input type="text" id="${fieldId}-value" value="${escapeHtml(value)}">
                            <button class="remove-field" onclick="removeCustomDetail('${scenarioId}', '${fieldId}')">x</button>
                        </div>
                    `);
                });

                customDetailsContainer.insertAdjacentHTML('beforeend', `
                    <div id="${scenarioId}-extra-custom-details"></div>
                    <button class="add-customdetail" onclick="addCustomDetailField('${scenarioId}')">Add Custom Detail</button>
                `);

                const toggleButton = customDetailsContainer.previousElementSibling;
                toggleButton.textContent = `Remove Custom Details from Scenario ${scenarioData.scenarioNumber || 1}`;
            }

            // Add event listeners
            addListenersToElement(document.getElementById(scenarioId));
        }

        /**
         * Utility functions
         */
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function addListenersToElement(element) {
            element.querySelectorAll('input, select').forEach(input => {
                input.addEventListener('change', updatePayload);

                if (input.id === 'routing_key') {
                    input.removeEventListener('input', handleRoutingKeyInput);
                    input.addEventListener('input', handleRoutingKeyInput);

                    input.addEventListener('paste', (e) => {
                        e.preventDefault();
                        const pastedText = (e.clipboardData || window.clipboardData).getData('text');
                        currentRoutingKey = pastedText;
                        currentRoutingKeyId = null;
                        input.value = maskRoutingKey(pastedText);
                        validateRoutingKey(pastedText);
                        updatePayload();
                    });

                    input.addEventListener('drop', (e) => {
                        e.preventDefault();
                    });

                    if (input.value && !input.value.includes('â€¢')) {
                        currentRoutingKey = input.value;
                        input.value = maskRoutingKey(input.value);
                    }
                } else {
                    input.addEventListener('input', updatePayload);
                }
            });
        }

        // Hide dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('routing-key-dropdown');
            const container = e.target.closest('.routing-key-container');
            if (!container && dropdown) {
                dropdown.style.display = 'none';
            }
        });

        function clearAllScenariosUI() {
            const scenarios = document.querySelectorAll('.scenario');

            if (scenarios.length === 0) {
                showToast('No scenarios to clear!', 'warning');
                return;
            }

            const scenarioCount = scenarios.length;
            const scenarioText = scenarioCount === 1 ? 'scenario' : 'scenarios';

            document.getElementById('scenarios-container').innerHTML = '';
            showToast(`Cleared ${scenarioCount} ${scenarioText} from view!<br>Adding a fresh scenario.`, 'success');

            addScenario();
        }

        function getCustomDetails(scenarioId) {
            const customDetailsContainer = document.getElementById(`${scenarioId}-custom-details`);
            if (customDetailsContainer.style.display === 'none') {
                return {};
            }

            const details = {};
            customDetailsContainer.querySelectorAll('.custom-field').forEach(field => {
                const label = field.querySelector('label').textContent.replace(':', '').trim();
                const value = field.querySelector('input:last-of-type').value;
                if (label && value) {
                    details[label] = value;
                }
            });
            return details;
        }

        function addScenario() {
            const container = document.getElementById('scenarios-container');
            const scenarioId = `scenario-${Date.now()}`;
            const scenarioCount = container.children.length + 1;

            const scenarioHtml = createScenarioHTML(scenarioId, scenarioCount);
            container.insertAdjacentHTML('beforeend', scenarioHtml);

            updateScenarioFields(scenarioId);
            addListenersToElement(document.getElementById(scenarioId));
            updatePayload();
        }

        function createScenarioHTML(scenarioId, scenarioCount) {
            return `
                <div id="${scenarioId}" class="scenario">
                    <div class="scenario-header colored-header">
                        <span class="scenario-title">Scenario <span class="scenario-number">${scenarioCount}</span>:</span>
                        <div class="scenario-type-container">
                            <select id="${scenarioId}-type" class="scenario-type bold-select" onchange="updateScenarioFields('${scenarioId}')">
                                <option value="application">Application Issues</option>
                                <option value="container">Container Issues</option>
                                <option value="cpu">CPU Issues</option>
                                <option value="database">Database Issues</option>
                                <option value="disk">Disk Issues</option>
                                <option value="login">Login Issues</option>
                                <option value="network">Network Issues</option>
                            </select>
                            <button class="remove-scenario" onclick="removeScenario('${scenarioId}')">Remove</button>
                        </div>
                    </div>
                    <div class="scenario-details">
                        <div class="field">
                            <label for="${scenarioId}-summary">Summary:</label>
                            <input type="text" id="${scenarioId}-summary" required>
                        </div>
                        <div class="field">
                            <label for="${scenarioId}-severity">Severity:</label>
                            <select id="${scenarioId}-severity">
                                <option value="critical">Critical</option>
                                <option value="error">Error</option>
                                <option value="warning">Warning</option>
                                <option value="info">Info</option>
                            </select>
                        </div>
                        <div class="field">
                            <label for="${scenarioId}-source">Source:</label>
                            <input type="text" id="${scenarioId}-source" required>
                        </div>
                        <div id="${scenarioId}-component-field" class="field">
                            <label for="${scenarioId}-component">Component:</label>
                            <input type="text" id="${scenarioId}-component">
                            <button class="remove-field" onclick="removeField('${scenarioId}-component-field')">x</button>
                        </div>
                        <div id="${scenarioId}-group-field" class="field">
                            <label for="${scenarioId}-group">Group:</label>
                            <input type="text" id="${scenarioId}-group">
                            <button class="remove-field" onclick="removeField('${scenarioId}-group-field')">x</button>
                        </div>
                        <div id="${scenarioId}-class-field" class="field">
                            <label for="${scenarioId}-class">Class:</label>
                            <input type="text" id="${scenarioId}-class">
                            <button class="remove-field" onclick="removeField('${scenarioId}-class-field')">x</button>
                        </div>
                        <div id="${scenarioId}-extra-fields"></div>
                        <button class="toggle-custom-details" onclick="toggleCustomDetails('${scenarioId}')">Add Custom Details for Scenario ${scenarioCount}</button>
                        <div id="${scenarioId}-custom-details" class="custom-details" style="display: none;"></div>
                    </div>
                </div>
            `;
        }

        function removeScenario(scenarioId) {
            document.getElementById(scenarioId).remove();
            updateScenarioNumbers();
            updatePayload();
        }

        function updateScenarioNumbers() {
            document.querySelectorAll('.scenario').forEach((scenario, index) => {
                const number = index + 1;
                scenario.querySelector('.scenario-number').textContent = number;

                const scenarioId = scenario.id;
                const toggleButton = scenario.querySelector('.toggle-custom-details');
                const customDetailsContainer = document.getElementById(`${scenarioId}-custom-details`);
                const isHidden = customDetailsContainer.style.display === 'none';
                toggleButton.textContent = isHidden
                    ? `Add Custom Details for Scenario ${number}`
                    : `Remove Custom Details from Scenario ${number}`;
            });
        }

        function updateScenarioFields(scenarioId, skipTemplateUpdate = false) {
            const type = document.getElementById(`${scenarioId}-type`).value;
            const template = scenarioTemplates[type];

            if (!skipTemplateUpdate) {
                ['summary', 'severity', 'source', 'component', 'group', 'class'].forEach(field => {
                    const el = document.getElementById(`${scenarioId}-${field}`);
                    if (el) el.value = template[field];
                });
                updateCustomDetails(scenarioId, template.customDetails);
            }

            updatePayload();
        }

        function updateCustomDetails(scenarioId, customDetails) {
            const container = document.getElementById(`${scenarioId}-custom-details`);
            const scenarioNumber = document.querySelector(`#${scenarioId} .scenario-number`).textContent;

            container.innerHTML = `<h3>Custom Details for Scenario ${scenarioNumber}</h3>`;

            Object.entries(customDetails).forEach(([key, value]) => {
                const fieldContainerId = `${scenarioId}-${key.toLowerCase().replace(/\s+/g, '-')}-field`;
                const fieldHtml = `
                    <div class="custom-field" id="${fieldContainerId}">
                        <label>${escapeHtml(key)}:</label>
                        <input type="text" value="${escapeHtml(value)}">
                        <button class="remove-field" onclick="removeField('${fieldContainerId}')">x</button>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', fieldHtml);
            });

            container.insertAdjacentHTML('beforeend', `
                <div id="${scenarioId}-extra-custom-details"></div>
                <button class="add-customdetail" onclick="addCustomDetailField('${scenarioId}')">Add Custom Detail</button>
            `);
        }

        function toggleCustomDetails(scenarioId) {
            const container = document.getElementById(`${scenarioId}-custom-details`);
            const toggleButton = container.previousElementSibling;
            const isHidden = container.style.display === 'none';
            const scenarioNumber = document.querySelector(`#${scenarioId} .scenario-number`).textContent;

            container.style.display = isHidden ? 'block' : 'none';
            toggleButton.textContent = isHidden
                ? `Remove Custom Details from Scenario ${scenarioNumber}`
                : `Add Custom Details for Scenario ${scenarioNumber}`;

            if (isHidden) {
                addListenersToElement(container);
            }

            updatePayload();
        }

        function addCustomDetailField(scenarioId) {
            const container = document.getElementById(`${scenarioId}-extra-custom-details`);
            const fieldId = `${scenarioId}-custom-${Date.now()}-field`;

            const fieldHtml = `
                <div class="custom-field" id="${fieldId}">
                    <label>
                        <input type="text" placeholder="Field name" onchange="updateCustomDetailLabel('${fieldId}')">
                    </label>
                    <input type="text" placeholder="Field value">
                    <button class="remove-field" onclick="removeField('${fieldId}')">x</button>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', fieldHtml);
            addListenersToElement(document.getElementById(fieldId));
            updatePayload();
        }

        function updateCustomDetailLabel(fieldId) {
            const field = document.getElementById(fieldId);
            const labelInput = field.querySelector('label input');
            field.querySelector('label').textContent = labelInput.value + ':';
        }

        function removeCustomDetail(scenarioId, fieldId) {
            const field = document.getElementById(fieldId);
            if (field) {
                field.remove();
                updatePayload();
            }
        }

        function getScenarioData(scenarioId) {
            const summary = document.getElementById(`${scenarioId}-summary`).value.trim();
            const source = document.getElementById(`${scenarioId}-source`).value.trim();
            const scenarioNumber = document.querySelector(`#${scenarioId} .scenario-number`).textContent;

            const missingFields = [];
            if (!summary) missingFields.push('Summary');
            if (!source) missingFields.push('Source');

            if (missingFields.length > 0) {
                throw new Error(`Scenario ${scenarioNumber}: ${missingFields.join(' and ')} ${missingFields.length > 1 ? 'are' : 'is'} mandatory.`);
            }

            const data = {
                summary: summary,
                severity: document.getElementById(`${scenarioId}-severity`).value,
                source: source,
                custom_details: {}
            };

            document.querySelectorAll(`#${scenarioId} .field`).forEach(field => {
                if (field.style.display !== 'none') {
                    const label = field.querySelector('label');
                    const input = field.querySelector('input:last-of-type, select');
                    if (label && input) {
                        const key = label.textContent.replace(':', '').trim().toLowerCase();
                        if (!['summary', 'severity', 'source'].includes(key)) {
                            data[key] = input.value;
                        }
                    }
                }
            });

            const customDetailsContainer = document.getElementById(`${scenarioId}-custom-details`);
            if (customDetailsContainer.style.display !== 'none') {
                customDetailsContainer.querySelectorAll('.custom-field').forEach(field => {
                    const label = field.querySelector('label');
                    const input = field.querySelector('input:last-of-type');
                    if (label && input) {
                        const key = label.textContent.replace(':', '').trim();
                        data.custom_details[key] = input.value;
                    }
                });
            }

            return data;
        }

        function removeField(fieldId) {
            document.getElementById(fieldId).remove();
            updatePayload();
        }

        function toggleDedupKeyField() {
            const eventAction = document.getElementById('event_action').value;
            const dedupKeyForTrigger = document.getElementById('dedup_key_for_trigger');
            const dedupKeyField = document.getElementById('dedup-key-field');
            const dedupKeyCheckboxLabel = document.getElementById('dedup-key-checkbox-label');

            if (eventAction === 'acknowledge' || eventAction === 'resolve') {
                dedupKeyField.style.display = 'flex';
                dedupKeyCheckboxLabel.style.display = 'none';
            } else if (eventAction === 'trigger') {
                dedupKeyCheckboxLabel.style.display = 'inline-flex';
                dedupKeyField.style.display = dedupKeyForTrigger.checked ? 'flex' : 'none';
            } else {
                dedupKeyField.style.display = 'none';
                dedupKeyCheckboxLabel.style.display = 'none';
            }

            updatePayload();
        }

        function sendEvents() {
            hidePayload();

            if (!currentRoutingKey) {
                showToast('Routing Key is mandatory.<br>This Key is your Event Orchestration or Service Integration Key.', 'error', 5000);
                return;
            }

            const eventAction = document.getElementById('event_action').value;
            const dedupKey = document.getElementById('dedup_key').value.trim();
            const dedupKeyForTrigger = document.getElementById('dedup_key_for_trigger').checked;
            const scenarios = document.querySelectorAll('.scenario');

            if ((eventAction === 'acknowledge' || eventAction === 'resolve') && !dedupKey) {
                showToast('Dedup Key is mandatory for acknowledge and resolve actions.', 'error', 5000);
                return;
            }

            if (eventAction === 'trigger' && dedupKeyForTrigger && !dedupKey) {
                showToast('Please add a Dedup Key or unmark the checkbox.', 'error', 5000);
                return;
            }

            if (scenarios.length === 0) {
                showToast('At least one scenario is required.', 'error', 5000);
                return;
            }

            document.getElementById('error-container').innerHTML = '';
            document.getElementById('result').innerHTML = '';

            const events = Array.from(scenarios).map(scenario => {
                try {
                    const scenarioData = getScenarioData(scenario.id);
                    const payload = generateEventPayload(scenarioData);
                    return fetch('https://events.pagerduty.com/v2/enqueue', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    }).then(response => {
                        if (!response.ok) {
                            return response.text().then(text => {
                                throw new Error(`API error: ${text}`);
                            });
                        }
                        return response.json();
                    }).then(data => ({ scenarioData, response: data }));
                } catch (error) {
                    return Promise.reject(error);
                }
            });

            Promise.all(events)
                .then(results => {
                    displaySuccessResults(results, eventAction);
                    // Update routing key usage if it's a saved key
                    if (currentRoutingKeyId) {
                        storage.updateRoutingKeyUsage(currentRoutingKeyId);
                    }
                })
                .catch(error => {
                    displayError(error.message);
                });
        }

        function displayError(errorMessage) {
                    let friendlyMessage = errorMessage;

                    if (errorMessage.includes('Invalid routing key')) {
                        friendlyMessage = 'Invalid routing key. Please check your routing key and try again.';
                    } else if (errorMessage.includes('Network')) {
                        friendlyMessage = 'Network error. Please check your internet connection and try again.';
                    } else if (errorMessage.includes('API error')) {
                        friendlyMessage = errorMessage;
                    }

                    document.getElementById('error-container').innerHTML = `
                        <div class="error-message">
                            <strong>Error:</strong> ${friendlyMessage}
                        </div>
                    `;
                    showToast('Failed to send events. Check error details above.', 'error');
                }

                function displaySuccessResults(results, eventAction) {
                    const actionText = eventAction === 'trigger' ? 'triggered' : eventAction + 'd';
                    const resultHtml = `
                        <h3>Success! Events ${actionText} ðŸŽ‰</h3>
                        <ul>
                            ${results.map((result, index) => `
                                <li>
                                    <strong>Scenario ${index + 1}:</strong> ${escapeHtml(result.scenarioData.summary)}
                                    <br><small>Dedup Key: ${result.response.dedup_key || 'Auto-generated'}</small>
                                </li>
                            `).join('')}
                        </ul>
                    `;
                    document.getElementById('result').innerHTML = resultHtml;
                    showToast(`Successfully ${actionText} ${results.length} event${results.length > 1 ? 's' : ''}!`, 'success');
                }

                function generateEventPayload(scenarioData) {
                    const eventAction = document.getElementById('event_action').value;
                    const dedupKey = document.getElementById('dedup_key').value.trim();
                    const dedupKeyForTrigger = document.getElementById('dedup_key_for_trigger').checked;
                    const client = document.getElementById('client').value;

                    const payload = {
                        routing_key: currentRoutingKey,
                        event_action: eventAction,
                        client: client
                    };

                    if (eventAction === 'trigger') {
                        payload.payload = {
                            summary: scenarioData.summary,
                            severity: scenarioData.severity,
                            source: scenarioData.source
                        };

                        // Add optional fields
                        ['component', 'group', 'class'].forEach(field => {
                            if (scenarioData[field]) {
                                payload.payload[field] = scenarioData[field];
                            }
                        });

                        // Add custom details
                        if (Object.keys(scenarioData.custom_details).length > 0) {
                            payload.payload.custom_details = scenarioData.custom_details;
                        }

                        // Add dedup key if specified
                        if (dedupKeyForTrigger && dedupKey) {
                            payload.dedup_key = dedupKey;
                        }
                    } else {
                        // For acknowledge/resolve actions
                        payload.dedup_key = dedupKey;
                    }

                    return payload;
                }

                function showPayload() {
                    if (!currentRoutingKey) {
                        showToast('Please enter a routing key first.', 'warning');
                        return;
                    }

                    const scenarios = document.querySelectorAll('.scenario');
                    if (scenarios.length === 0) {
                        showToast('Please add at least one scenario.', 'warning');
                        return;
                    }

                    try {
                        const payloads = Array.from(scenarios).map(scenario => {
                            const scenarioData = getScenarioData(scenario.id);
                            return generateEventPayload(scenarioData);
                        });

                        const payloadPreview = document.getElementById('payload-preview');
                        const preElement = payloadPreview.querySelector('.payload-preview');

                        preElement.textContent = payloads.map(payload =>
                            JSON.stringify(payload, null, 2)
                        ).join('\n\n---\n\n');

                        payloadPreview.style.display = 'block';
                        document.getElementById('showPayloadBtn').style.display = 'none';
                        document.getElementById('hidePayloadBtn').style.display = 'inline-block';
                    } catch (error) {
                        showToast(`Error generating payload: ${error.message}`, 'error');
                    }
                }

                function hidePayload() {
                    document.getElementById('payload-preview').style.display = 'none';
                    document.getElementById('showPayloadBtn').style.display = 'inline-block';
                    document.getElementById('hidePayloadBtn').style.display = 'none';
                }

                function updatePayload() {
                    const payloadPreview = document.getElementById('payload-preview');
                    if (payloadPreview.style.display === 'block') {
                        showPayload();
                    }
                }

                function downloadShellScript() {
                    if (!currentRoutingKey) {
                        showToast('Please enter a routing key first.', 'warning');
                        return;
                    }

                    const scenarios = document.querySelectorAll('.scenario');
                    if (scenarios.length === 0) {
                        showToast('Please add at least one scenario.', 'warning');
                        return;
                    }

                    try {
                        const payloads = Array.from(scenarios).map(scenario => {
                            const scenarioData = getScenarioData(scenario.id);
                            return generateEventPayload(scenarioData);
                        });

                        let script = '#!/bin/bash\n\n';
                        script += '# KrakenDuty - PagerDuty Event Sender Script\n';
                        script += '# Generated on: ' + new Date().toISOString() + '\n\n';
                        script += 'echo "ðŸ¦‘ KrakenDuty - Sending PagerDuty Events..."\n\n';

                        payloads.forEach((payload, index) => {
                            script += `echo "Sending event ${index + 1}/${payloads.length}..."\n`;
                            script += `curl -X POST https://events.pagerduty.com/v2/enqueue \\\n`;
                            script += `  -H "Content-Type: application/json" \\\n`;
                            script += `  -d '${JSON.stringify(payload)}'\n\n`;
                        });

                        script += 'echo "âœ… All events sent!"\n';

                        const blob = new Blob([script], { type: 'text/plain' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'krakenduty-events.sh';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);

                        showToast('Shell script downloaded successfully!', 'success');
                    } catch (error) {
                        showToast(`Error generating script: ${error.message}`, 'error');
                    }
                }

                /**
                 * Toast notification system
                 */
                function showToast(message, type = 'info', duration = 3000) {
                    const container = getOrCreateToastContainer();

                    const toast = document.createElement('div');
                    toast.className = `toast ${type}`;
                    toast.innerHTML = `
                        <span>${message}</span>
                        <button class="close-toast" onclick="closeToast(this)">&times;</button>
                    `;

                    container.appendChild(toast);

                    // Auto-remove after duration
                    setTimeout(() => {
                        if (toast.parentNode) {
                            closeToast(toast.querySelector('.close-toast'));
                        }
                    }, duration);
                }

                function getOrCreateToastContainer() {
                    let container = document.querySelector('.toast-container');
                    if (!container) {
                        container = document.createElement('div');
                        container.className = 'toast-container';
                        document.body.appendChild(container);
                    }
                    return container;
                }

                function closeToast(button) {
                    const toast = button.parentNode;
                    toast.classList.add('hiding');
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    }, 300);
                }

                /**
                 * Initialize the application
                 */
                document.addEventListener('DOMContentLoaded', function() {
                    // Initialize routing key field
                    const routingKeyField = document.getElementById('routing_key');
                    addListenersToElement(document.body);

                    // Add initial scenario
                    addScenario();

                    // Initialize dedup key field visibility
                    toggleDedupKeyField();

                    // Show welcome message
                    // showToast('Welcome to KrakenDuty! ðŸ¦‘ Enhanced with persistent storage.', 'info', 4000);
                });

                // Prevent form submission on Enter key
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && e.target.tagName !== 'BUTTON') {
                        e.preventDefault();
                    }
                });
            </script>
        </body>
        </html>
